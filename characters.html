<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Characters</title>
<link rel="stylesheet" href="styles.css" />
<style>
/* Minimal styles so you can see states even if styles.css fails */
body{background:#0f1412;color:#e9eee9;font:16px system-ui;margin:0}
.wrap{max-width:960px;margin:0 auto;padding:16px}
h1{margin:8px 0 6px 0}
.sub{opacity:.8;margin:0 0 12px 0}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:10px 0}
.pill{appearance:none;border:1px solid #2a3a31;background:#12201a;color:#e9eee9;border-radius:999px;padding:8px 12px}
.pill.active,.pill.primary{background:#2f6f4f;border-color:#2f6f4f}
.ghost{background:transparent}
input[type="text"]{background:#0f1412;border:1px solid #2a3a31;color:#e9eee9;border-radius:12px;padding:10px;min-width:220px}
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}
.card{border:1px solid #2a3a31;background:#0f1915;border-radius:16px;padding:12px}
.card .top{display:flex;gap:12px}
.avatar{width:56px;height:56px;border-radius:12px;object-fit:cover;background:#0f1412;border:1px solid #2a3a31}
.name{font-weight:700}
.tags{margin-top:6px;display:flex;gap:6px;flex-wrap:wrap}
.tag{font-size:12px;padding:4px 8px;background:#132018;border:1px solid #2a3a31;border-radius:999px}
.actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.section{border:1px dashed #2a3a31;border-radius:12px;padding:12px;margin:12px 0}
.sticky-save{position:sticky;bottom:0;background:#0f1412;padding:8px;display:flex;gap:8px}
.is-fav{box-shadow:0 0 0 2px #d4af37 inset}
.sparkles-off .card{box-shadow:none}
</style>
</head>
<body>
<div class="wrap">
  <h1>Characters</h1>
  <p class="sub">Build realistic presets with pics, traits, sliders & notes. Saved locally.</p>

  <!-- top controls -->
  <div class="row">
    <input id="search" type="text" placeholder="Search characters…" />
    <button class="pill" id="btn-cards">Cards</button>
    <button class="pill" id="btn-list">List</button>
    <button class="pill" id="btn-spark">Sparkles Off</button>
    <button class="pill" id="btn-export">Export JSON</button>
    <button class="pill" id="btn-import">Import JSON</button>
    <button class="pill primary" id="btn-add">+ Add Character</button>
  </div>

  <div class="row">
    <button class="pill active">All</button>
    <button class="pill">Hunter</button>
    <button class="pill">Canon</button>
    <button class="pill">OC</button>
  </div>

  <!-- tabs -->
  <div class="row">
    <button class="pill tab active" data-tab="roster">Roster</button>
    <button class="pill tab" data-tab="editor">New · Edit</button>
  </div>

  <!-- roster -->
  <section id="tab-roster">
    <div class="cards">
      <article class="card">
        <div class="top">
          <img class="avatar" src="" alt="">
          <div>
            <div class="name">Dean Winchester</div>
            <div class="tags">
              <span class="tag">hunter</span>
              <span class="tag">canon</span>
              <span class="tag">protective</span>
            </div>
          </div>
        </div>
        <div class="actions">
          <button class="pill primary">Use in Chat</button>
          <button class="pill primary">Use in Writer</button>
          <button class="pill ghost">Edit</button>
          <button class="pill ghost">Duplicate</button>
          <button class="pill ghost">Favorite</button>
          <button class="pill ghost">Delete</button>
        </div>
      </article>

      <article class="card">
        <div class="top">
          <img class="avatar" src="" alt="">
          <div>
            <div class="name">Your OC</div>
            <div class="tags">
              <span class="tag">oc</span>
              <span class="tag">slow-burn</span>
              <span class="tag">snarky</span>
            </div>
          </div>
        </div>
        <div class="actions">
          <button class="pill primary">Use in Chat</button>
          <button class="pill primary">Use in Writer</button>
          <button class="pill ghost">Edit</button>
          <button class="pill ghost">Duplicate</button>
          <button class="pill ghost">Favorite</button>
          <button class="pill ghost">Delete</button>
        </div>
      </article>
    </div>
  </section>

  <!-- editor -->
  <section id="tab-editor" style="display:none">
    <div class="section">
      <div class="row">
        <button class="pill ghost" id="btn-upload">Upload Picture</button>
        <button class="pill ghost" id="btn-clearpic">Clear Picture</button>
      </div>
      <div id="pic-preview" style="display:none">
        <img id="pic-img" class="avatar" alt="Preview">
      </div>
    </div>

    <div class="section">
      <div class="row"><input id="fld-name" type="text" placeholder="Name" class="grow"></div>
      <div class="row"><input id="fld-tags" type="text" placeholder="Tags (comma separated)" class="grow"></div>
      <div class="row"><input id="fld-appearance" type="text" placeholder="Appearance notes" class="grow"></div>
      <div class="row"><input id="fld-personality" type="text" placeholder="Personality" class="grow"></div>
      <div class="row"><input id="fld-voice" type="text" placeholder="Voice / manner" class="grow"></div>
      <div class="row"><input id="fld-bounds" type="text" placeholder="Boundaries & morals" class="grow"></div>
      <div class="row"><input id="fld-tones" type="text" placeholder="Special tones / rules" class="grow"></div>
      <div class="row"><input id="fld-rel" type="text" placeholder="Relationship mode" class="grow"></div>
      <div class="row"><input id="fld-notes" type="text" placeholder="Sample prompts / notes" class="grow"></div>
    </div>

    <div class="sticky-save">
      <button class="pill primary" id="btn-save">Save Character</button>
      <button class="pill ghost" id="btn-undo">Undo</button>
    </div>
  </section>
</div>

<!-- Inline wiring so nothing can fail to load -->
<script>
(() => {
  const $ = (s, r=document)=>r.querySelector(s);
  const $$=(s, r=document)=>Array.from(r.querySelectorAll(s));

  // visible "loaded" chip
  const chip=document.createElement('div');
  chip.textContent='Loaded ✓ characters v4';
  chip.style.cssText='position:fixed;bottom:10px;right:10px;background:#2f6f4f;color:#eaffec;padding:6px 10px;border-radius:999px;font:12px system-ui;z-index:9999';
  document.body.appendChild(chip);

  // tabs
  const rosterBtn=$('.tab[data-tab="roster"]');
  const editorBtn=$('.tab[data-tab="editor"]');
  const roster=$('#tab-roster');
  const editor=$('#tab-editor');
  function goTab(k){
    [rosterBtn,editorBtn].forEach(b=>b&&b.classList.remove('active'));
    if(k==='editor'){ roster.style.display='none'; editor.style.display='block'; editorBtn.classList.add('active'); window.scrollTo({top:0,behavior:'smooth'}); }
    else { editor.style.display='none'; roster.style.display='block'; rosterBtn.classList.add('active'); }
  }
  rosterBtn?.addEventListener('click',()=>goTab('roster'));
  editorBtn?.addEventListener('click',()=>goTab('editor'));

  // sparkles toggle
  $('#btn-spark')?.addEventListener('click',e=>{
    document.body.classList.toggle('sparkles-off');
    e.target.textContent=document.body.classList.contains('sparkles-off')?'Sparkles On':'Sparkles Off';
  });

  // search
  const search=$('#search'); const cards=$('.cards');
  function applySearch(){
    const q=(search?.value||'').toLowerCase();
    $$('.card',cards).forEach(c=>{
      c.style.display = !q || c.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
  }
  search?.addEventListener('input',applySearch);

  // tag filter row (All/Hunter/Canon/OC)
  const tagRow = $$('.row')[1];
  tagRow?.addEventListener('click',e=>{
    const b=e.target.closest('.pill'); if(!b) return;
    $$('.pill',tagRow).forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    const t=b.textContent.trim().toLowerCase();
    $$('.card',cards).forEach(card=>{
      if(t==='all'){ card.style.display=''; return; }
      const hit=$$('.tag',card).some(x=>x.textContent.trim().toLowerCase()===t);
      card.style.display = hit ? '' : 'none';
    });
  });

  // roster actions
  cards?.addEventListener('click',e=>{
    const btn=e.target.closest('button'); if(!btn) return;
    const card=e.target.closest('.card'); const name=card?.querySelector('.name')?.textContent?.trim()||'Character';
    const label=btn.textContent.trim().toLowerCase();

    if(label.startsWith('use in writer')){
      location.href=`story-writer.html?char=${encodeURIComponent(name)}`;
    } else if(label.startsWith('use in chat')){
      location.href=`story-writer.html#chat?char=${encodeURIComponent(name)}`;
    } else if(label==='edit'){
      goTab('editor');
    } else if(label==='duplicate'){
      const clone=card.cloneNode(true); cards.appendChild(clone);
    } else if(label==='favorite'){
      card.classList.toggle('is-fav'); btn.classList.toggle('primary');
    } else if(label==='delete'){
      card.remove();
    }
  });

  // add character -> editor
  $('#btn-add')?.addEventListener('click',()=>goTab('editor'));

  // export
  $('#btn-export')?.addEventListener('click',()=>{
    const payload=$$('.card',cards).map(c=>({
      name:c.querySelector('.name')?.textContent?.trim()||'',
      tags:$$('.tag',c).map(t=>t.textContent.trim()),
      avatar:c.querySelector('.avatar')?.getAttribute('src')||''
    }));
    const blob=new Blob([JSON.stringify({cards:payload},null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='characters.json'; a.click(); URL.revokeObjectURL(a.href);
  });

  // import
  $('#btn-import')?.addEventListener('click',()=>{
    const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
    inp.onchange=async()=>{ const f=inp.files?.[0]; if(!f) return;
      let data; try{data=JSON.parse(await f.text())}catch{return alert('Bad JSON')}
      if(!Array.isArray(data.cards)) return alert('JSON missing "cards"');
      data.cards.forEach(c=>{
        const el=document.createElement('article'); el.className='card';
        el.innerHTML=`
          <div class="top">
            <img class="avatar" src="${(c.avatar||'').replace(/"/g,'&quot;')}" alt="">
            <div>
              <div class="name">${(c.name||'Unnamed').replace(/</g,'&lt;')}</div>
              <div class="tags">${(c.tags||[]).map(t=>`<span class="tag">${String(t).replace(/</g,'&lt;')}</span>`).join('')}</div>
            </div>
          </div>
          <div class="actions">
            <button class="pill primary">Use in Chat</button>
            <button class="pill primary">Use in Writer</button>
            <button class="pill ghost">Edit</button>
            <button class="pill ghost">Duplicate</button>
            <button class="pill ghost">Favorite</button>
            <button class="pill ghost">Delete</button>
          </div>`;
        cards.appendChild(el);
      });
      goTab('roster');
    };
    inp.click();
  });

  // editor: upload preview
  const up=$('#btn-upload'), clr=$('#btn-clearpic'), prevBox=$('#pic-preview'), prevImg=$('#pic-img');
  up?.addEventListener('click',()=>{
    const i=document.createElement('input'); i.type='file'; i.accept='image/*';
    i.onchange=()=>{ const f=i.files?.[0]; if(!f) return;
      const r=new FileReader(); r.onload=()=>{ prevImg.src=r.result; prevBox.style.display='block'; }; r.readAsDataURL(f);
    };
    i.click();
  });
  clr?.addEventListener('click',()=>{ prevImg.src=''; prevBox.style.display='none'; });

  // save/undo demos so buttons aren’t dead
  $('#btn-save')?.addEventListener('click',()=>alert('Saved (demo). Next: persist to localStorage.'));
  $('#btn-undo')?.addEventListener('click',()=>alert('Undone (demo).'));
})();
</script>
</body>
</html>