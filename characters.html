<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Characters</title>
<link rel="stylesheet" href="styles.css" />
<style>
/* Minimal styles so you can see states even if styles.css fails */
body{background:#0f1412;color:#e9eee9;font:16px system-ui;margin:0}
.wrap{max-width:960px;margin:0 auto;padding:16px}
h1{margin:8px 0 6px 0}
.sub{opacity:.8;margin:0 0 12px 0}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:10px 0}
.pill{appearance:none;border:1px solid #2a3a31;background:#12201a;color:#e9eee9;border-radius:999px;padding:8px 12px}
.pill.active,.pill.primary{background:#2f6f4f;border-color:#2f6f4f}
.ghost{background:transparent}
input[type="text"]{background:#0f1412;border:1px solid #2a3a31;color:#e9eee9;border-radius:12px;padding:10px;min-width:220px}
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}
.card{border:1px solid #2a3a31;background:#0f1915;border-radius:16px;padding:12px}
.card .top{display:flex;gap:12px}
.avatar{width:56px;height:56px;border-radius:12px;object-fit:cover;background:#0f1412;border:1px solid #2a3a31}
.name{font-weight:700}
.tags{margin-top:6px;display:flex;gap:6px;flex-wrap:wrap}
.tag{font-size:12px;padding:4px 8px;background:#132018;border:1px solid #2a3a31;border-radius:999px}
.actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.section{border:1px dashed #2a3a31;border-radius:12px;padding:12px;margin:12px 0}
.sticky-save{position:sticky;bottom:0;background:#0f1412;padding:8px;display:flex;gap:8px}
.is-fav{box-shadow:0 0 0 2px #d4af37 inset}
.sparkles-off .card{box-shadow:none}
</style>
</head>
<body>
<div class="wrap">
  <h1>Characters</h1>
  <p class="sub">Build realistic presets with pics, traits, sliders & notes. Saved locally.</p>

  <!-- top controls -->
  <div class="row">
    <input id="search" type="text" placeholder="Search characters…" />
    <button class="pill" id="btn-cards">Cards</button>
    <button class="pill" id="btn-list">List</button>
    <button class="pill" id="btn-spark">Sparkles Off</button>
    <button class="pill" id="btn-export">Export JSON</button>
    <button class="pill" id="btn-import">Import JSON</button>
    <button class="pill primary" id="btn-add">+ Add Character</button>
  </div>

  <div class="row">
    <button class="pill active">All</button>
    <button class="pill">Hunter</button>
    <button class="pill">Canon</button>
    <button class="pill">OC</button>
  </div>

  <!-- tabs -->
  <div class="row">
    <button class="pill tab active" data-tab="roster">Roster</button>
    <button class="pill tab" data-tab="editor">New · Edit</button>
  </div>

  <!-- roster -->
  <section id="tab-roster">
    <div class="cards">
      <article class="card">
        <div class="top">
          <img class="avatar" src="" alt="">
          <div>
            <div class="name">Dean Winchester</div>
            <div class="tags">
              <span class="tag">hunter</span>
              <span class="tag">canon</span>
              <span class="tag">protective</span>
            </div>
          </div>
        </div>
        <div class="actions">
          <button class="pill primary">Use in Chat</button>
          <button class="pill primary">Use in Writer</button>
          <button class="pill ghost">Edit</button>
          <button class="pill ghost">Duplicate</button>
          <button class="pill ghost">Favorite</button>
          <button class="pill ghost">Delete</button>
        </div>
      </article>

      <article class="card">
        <div class="top">
          <img class="avatar" src="" alt="">
          <div>
            <div class="name">Your OC</div>
            <div class="tags">
              <span class="tag">oc</span>
              <span class="tag">slow-burn</span>
              <span class="tag">snarky</span>
            </div>
          </div>
        </div>
        <div class="actions">
          <button class="pill primary">Use in Chat</button>
          <button class="pill primary">Use in Writer</button>
          <button class="pill ghost">Edit</button>
          <button class="pill ghost">Duplicate</button>
          <button class="pill ghost">Favorite</button>
          <button class="pill ghost">Delete</button>
        </div>
      </article>
    </div>
  </section>

  <!-- editor -->
  <section id="tab-editor" style="display:none">
    <div class="section">
      <div class="row">
        <button class="pill ghost" id="btn-upload">Upload Picture</button>
        <button class="pill ghost" id="btn-clearpic">Clear Picture</button>
      </div>
      <div id="pic-preview" style="display:none">
        <img id="pic-img" class="avatar" alt="Preview">
      </div>
    </div>

    <div class="section">
      <div class="row"><input id="fld-name" type="text" placeholder="Name" class="grow"></div>
      <div class="row"><input id="fld-tags" type="text" placeholder="Tags (comma separated)" class="grow"></div>
      <div class="row"><input id="fld-appearance" type="text" placeholder="Appearance notes" class="grow"></div>
      <div class="row"><input id="fld-personality" type="text" placeholder="Personality" class="grow"></div>
      <div class="row"><input id="fld-voice" type="text" placeholder="Voice / manner" class="grow"></div>
      <div class="row"><input id="fld-bounds" type="text" placeholder="Boundaries & morals" class="grow"></div>
      <div class="row"><input id="fld-tones" type="text" placeholder="Special tones / rules" class="grow"></div>
      <div class="row"><input id="fld-rel" type="text" placeholder="Relationship mode" class="grow"></div>
      <div class="row"><input id="fld-notes" type="text" placeholder="Sample prompts / notes" class="grow"></div>
    </div>

    <div class="sticky-save">
      <button class="pill primary" id="btn-save">Save Character</button>
      <button class="pill ghost" id="btn-undo">Undo</button>
    </div>
  </section>
</div>

<!-- Inline wiring so nothing can fail to load -->
<script>
(() => {
  // ---------- tiny helpers ----------
  const $  = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
  const uid = ()=>'c_'+Math.random().toString(36).slice(2)+Date.now().toString(36);

  // version chip so we know the new code loaded
  const chip=document.createElement('div');
  chip.textContent='Loaded ✓ characters v5';
  chip.style.cssText='position:fixed;bottom:10px;right:10px;background:#2f6f4f;color:#eaffec;padding:6px 10px;border-radius:999px;font:12px system-ui;z-index:9999';
  document.body.appendChild(chip);

  // ---------- storage ----------
  const STORE_KEY = 'creative.characters.v1';
  const SEL_KEY   = 'creative.selectedCharId';

  function loadAll(){
    try {
      const raw = localStorage.getItem(STORE_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      if (!Array.isArray(arr)) return [];
      return arr;
    } catch { return []; }
  }
  function saveAll(arr){
    localStorage.setItem(STORE_KEY, JSON.stringify(arr));
  }
  function getById(id){ return loadAll().find(x=>x.id===id); }
  function upsert(item){
    const list = loadAll();
    const idx = list.findIndex(x=>x.id===item.id);
    if (idx>=0) list[idx]=item; else list.push(item);
    saveAll(list);
  }
  function remove(id){
    const list = loadAll().filter(x=>x.id!==id);
    saveAll(list);
  }

  // ---------- DOM refs ----------
  const rosterBtn = $('.tab[data-tab="roster"]');
  const editorBtn = $('.tab[data-tab="editor"]');
  const roster    = $('#tab-roster');
  const editor    = $('#tab-editor');
  const cardsWrap = $('.cards', roster);
  const search    = $('#search');

  // Editor fields
  const fld = {
    name:        $('#fld-name'),
    tags:        $('#fld-tags'),
    appearance:  $('#fld-appearance'),
    personality: $('#fld-personality'),
    voice:       $('#fld-voice'),
    bounds:      $('#fld-bounds'),
    tones:       $('#fld-tones'),
    rel:         $('#fld-rel'),
    notes:       $('#fld-notes'),
  };
  const upBtn  = $('#btn-upload');
  const clrBtn = $('#btn-clearpic');
  const prevBox= $('#pic-preview');
  const prevImg= $('#pic-img');
  const saveBtn= $('#btn-save');
  const undoBtn= $('#btn-undo');

  let editingId = null;     // null = creating new
  let currentPicData = '';  // dataURL for avatar

  // ---------- UI: tabs ----------
  function goTab(k){
    [rosterBtn,editorBtn].forEach(b=>b?.classList.remove('active'));
    if(k==='editor'){
      roster.style.display='none';
      editor.style.display='block';
      editorBtn?.classList.add('active');
      window.scrollTo({top:0,behavior:'smooth'});
    } else {
      editor.style.display='none';
      roster.style.display='block';
      rosterBtn?.classList.add('active');
    }
  }
  rosterBtn?.addEventListener('click',()=>goTab('roster'));
  editorBtn?.addEventListener('click',()=>goTab('editor'));

  // ---------- Roster rendering ----------
  function tagPills(tags){
    return (tags||[]).filter(Boolean).map(t=>`<span class="tag">${String(t).trim().replace(/</g,'&lt;')}</span>`).join('');
  }
  function cardHTML(c){
    return `
      <article class="card ${c.favorite?'is-fav':''}" data-id="${c.id}">
        <div class="top">
          <img class="avatar" src="${(c.avatar||'')}" alt="">
          <div>
            <div class="name">${(c.name||'Unnamed').replace(/</g,'&lt;')}</div>
            <div class="tags">${tagPills(c.tags)}</div>
          </div>
        </div>
        <div class="actions">
          <button class="pill primary act-chat">Use in Chat</button>
          <button class="pill primary act-write">Use in Writer</button>
          <button class="pill ghost act-edit">Edit</button>
          <button class="pill ghost act-dup">Duplicate</button>
          <button class="pill ghost act-fav">${c.favorite?'Unfavorite':'Favorite'}</button>
          <button class="pill ghost act-del">Delete</button>
        </div>
      </article>`;
  }
  function renderRoster(){
    const q = (search?.value||'').toLowerCase();
    const list = loadAll();
    if (!list.length) {
      cardsWrap.innerHTML = `
        <article class="card">
          <div class="name">No characters yet</div>
          <div class="actions"><button class="pill primary" id="cta-create">Create one</button></div>
        </article>`;
      $('#cta-create')?.addEventListener('click', ()=>{ beginCreate(); });
      return;
    }
    cardsWrap.innerHTML = list
      .filter(c => !q || JSON.stringify(c).toLowerCase().includes(q))
      .map(cardHTML)
      .join('');
  }

  // ---------- Search & filter ----------
  search?.addEventListener('input', renderRoster);

  // ---------- Top buttons ----------
  $('#btn-spark')?.addEventListener('click',e=>{
    document.body.classList.toggle('sparkles-off');
    e.target.textContent=document.body.classList.contains('sparkles-off')?'Sparkles On':'Sparkles Off';
  });
  $('#btn-cards')?.addEventListener('click',()=>document.body.classList.remove('list-mode'));
  $('#btn-list')?.addEventListener('click',()=>document.body.classList.add('list-mode'));

  // Export: full schema
  $('#btn-export')?.addEventListener('click',()=>{
    const blob=new Blob([JSON.stringify({version:1, characters:loadAll()},null,2)],{type:'application/json'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob); a.download='characters.json'; a.click(); URL.revokeObjectURL(a.href);
  });

  // Import
  $('#btn-import')?.addEventListener('click',()=>{
    const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
    inp.onchange=async()=>{
      const f=inp.files?.[0]; if(!f) return;
      let data; try{data=JSON.parse(await f.text())}catch{ return alert('Bad JSON'); }
      const items = Array.isArray(data) ? data : (data.characters||[]);
      const clean = items.map(x=>({
        id: uid(),
        name: x.name||'Unnamed',
        tags: Array.isArray(x.tags)?x.tags:[],
        avatar: x.avatar||'',
        appearance: x.appearance||'',
        personality: x.personality||'',
        voice: x.voice||'',
        bounds: x.bounds||'',
        tones: x.tones||'',
        rel: x.rel||'',
        notes: x.notes||'',
        favorite: !!x.favorite,
      }));
      const merged = [...loadAll(), ...clean];
      saveAll(merged);
      renderRoster(); goTab('roster');
    };
    inp.click();
  });

  // ---------- Roster actions (delegate) ----------
  cardsWrap?.addEventListener('click', (e)=>{
    const card = e.target.closest('.card'); if(!card) return;
    const id   = card.getAttribute('data-id');
    const c    = getById(id);
    if(!c) return;

    if (e.target.closest('.act-edit')) {
      beginEdit(c);
    } else if (e.target.closest('.act-dup')) {
      const copy = {...c, id: uid(), name: (c.name||'Unnamed')+' (copy)', favorite:false};
      upsert(copy); renderRoster();
    } else if (e.target.closest('.act-fav')) {
      c.favorite = !c.favorite; upsert(c); renderRoster();
    } else if (e.target.closest('.act-del')) {
      if (confirm(`Delete "${c.name}"?`)) { remove(id); renderRoster(); }
    } else if (e.target.closest('.act-write')) {
      localStorage.setItem(SEL_KEY, id);
      location.href = `story-writer.html?char=${encodeURIComponent(c.name||'')}`;
    } else if (e.target.closest('.act-chat')) {
      localStorage.setItem(SEL_KEY, id);
      location.href = `story-writer.html#chat?char=${encodeURIComponent(c.name||'')}`;
    }
  });

  // ---------- Create / Edit ----------
  $('#btn-add')?.addEventListener('click', ()=>beginCreate());

  function clearEditor(){
    editingId = null;
    currentPicData = '';
    prevImg.src=''; prevBox.style.display='none';
    for (const k in fld) fld[k].value='';
  }
  function fillEditor(c){
    editingId = c.id;
    currentPicData = c.avatar||'';
    if (currentPicData) { prevImg.src=currentPicData; prevBox.style.display='block'; }
    fld.name.value        = c.name||'';
    fld.tags.value        = (c.tags||[]).join(', ');
    fld.appearance.value  = c.appearance||'';
    fld.personality.value = c.personality||'';
    fld.voice.value       = c.voice||'';
    fld.bounds.value      = c.bounds||'';
    fld.tones.value       = c.tones||'';
    fld.rel.value         = c.rel||'';
    fld.notes.value       = c.notes||'';
  }
  function beginCreate(){ clearEditor(); goTab('editor'); }
  function beginEdit(c){ clearEditor(); fillEditor(c); goTab('editor'); }

  // Upload picture -> dataURL (saved inside character)
  upBtn?.addEventListener('click',()=>{
    const i=document.createElement('input'); i.type='file'; i.accept='image/*';
    i.onchange=()=>{
      const f=i.files?.[0]; if(!f) return;
      const r=new FileReader();
      r.onload=()=>{ currentPicData=r.result; prevImg.src=currentPicData; prevBox.style.display='block'; };
      r.readAsDataURL(f);
    };
    i.click();
  });
  clrBtn?.addEventListener('click',()=>{ currentPicData=''; prevImg.src=''; prevBox.style.display='none'; });

  // Save -> upsert into localStorage, then return to roster
  saveBtn?.addEventListener('click', ()=>{
    const obj = {
      id: editingId || uid(),
      name: fld.name.value.trim() || 'Unnamed',
      tags: fld.tags.value.split(',').map(s=>s.trim()).filter(Boolean),
      avatar: currentPicData || '',
      appearance:  fld.appearance.value.trim(),
      personality: fld.personality.value.trim(),
      voice:       fld.voice.value.trim(),
      bounds:      fld.bounds.value.trim(),
      tones:       fld.tones.value.trim(),
      rel:         fld.rel.value.trim(),
      notes:       fld.notes.value.trim(),
      favorite: editingId ? (getById(editingId)?.favorite||false) : false,
    };
    upsert(obj);
    renderRoster(); goTab('roster');
  });

  // Undo = clear editor (for now)
  undoBtn?.addEventListener('click', ()=>clearEditor());

  // ---------- First render ----------
  // If no data yet, seed with two example cards once
  if (!loadAll().length) {
    const seed = [
      {id:uid(), name:'Dean Winchester', tags:['hunter','canon','protective'], avatar:'', appearance:'', personality:'', voice:'', bounds:'', tones:'', rel:'', notes:'', favorite:false},
      {id:uid(), name:'Your OC',          tags:['oc','slow-burn','snarky'],    avatar:'', appearance:'', personality:'', voice:'', bounds:'', tones:'', rel:'', notes:'', favorite:false},
    ];
    saveAll(seed);
  }
  renderRoster();
})();
</script>
  chip.style.cssText='position:fixed;bottom:10px;right:10px;background:#2f6f4f;color:#eaffec;padding:6px 10px;border-radius:999px;font:12px system-ui;z-index:9999';
  document.body.appendChild(chip);

  // tabs
  const rosterBtn=$('.tab[data-tab="roster"]');
  const editorBtn=$('.tab[data-tab="editor"]');
  const roster=$('#tab-roster');
  const editor=$('#tab-editor');
  function goTab(k){
    [rosterBtn,editorBtn].forEach(b=>b&&b.classList.remove('active'));
    if(k==='editor'){ roster.style.display='none'; editor.style.display='block'; editorBtn.classList.add('active'); window.scrollTo({top:0,behavior:'smooth'}); }
    else { editor.style.display='none'; roster.style.display='block'; rosterBtn.classList.add('active'); }
  }
  rosterBtn?.addEventListener('click',()=>goTab('roster'));
  editorBtn?.addEventListener('click',()=>goTab('editor'));

  // sparkles toggle
  $('#btn-spark')?.addEventListener('click',e=>{
    document.body.classList.toggle('sparkles-off');
    e.target.textContent=document.body.classList.contains('sparkles-off')?'Sparkles On':'Sparkles Off';
  });

  // search
  const search=$('#search'); const cards=$('.cards');
  function applySearch(){
    const q=(search?.value||'').toLowerCase();
    $$('.card',cards).forEach(c=>{
      c.style.display = !q || c.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
  }
  search?.addEventListener('input',applySearch);

  // tag filter row (All/Hunter/Canon/OC)
  const tagRow = $$('.row')[1];
  tagRow?.addEventListener('click',e=>{
    const b=e.target.closest('.pill'); if(!b) return;
    $$('.pill',tagRow).forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    const t=b.textContent.trim().toLowerCase();
    $$('.card',cards).forEach(card=>{
      if(t==='all'){ card.style.display=''; return; }
      const hit=$$('.tag',card).some(x=>x.textContent.trim().toLowerCase()===t);
      card.style.display = hit ? '' : 'none';
    });
  });

  // roster actions
  cards?.addEventListener('click',e=>{
    const btn=e.target.closest('button'); if(!btn) return;
    const card=e.target.closest('.card'); const name=card?.querySelector('.name')?.textContent?.trim()||'Character';
    const label=btn.textContent.trim().toLowerCase();

    if(label.startsWith('use in writer')){
      location.href=`story-writer.html?char=${encodeURIComponent(name)}`;
    } else if(label.startsWith('use in chat')){
      location.href=`story-writer.html#chat?char=${encodeURIComponent(name)}`;
    } else if(label==='edit'){
      goTab('editor');
    } else if(label==='duplicate'){
      const clone=card.cloneNode(true); cards.appendChild(clone);
    } else if(label==='favorite'){
      card.classList.toggle('is-fav'); btn.classList.toggle('primary');
    } else if(label==='delete'){
      card.remove();
    }
  });

  // add character -> editor
  $('#btn-add')?.addEventListener('click',()=>goTab('editor'));

  // export
  $('#btn-export')?.addEventListener('click',()=>{
    const payload=$$('.card',cards).map(c=>({
      name:c.querySelector('.name')?.textContent?.trim()||'',
      tags:$$('.tag',c).map(t=>t.textContent.trim()),
      avatar:c.querySelector('.avatar')?.getAttribute('src')||''
    }));
    const blob=new Blob([JSON.stringify({cards:payload},null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='characters.json'; a.click(); URL.revokeObjectURL(a.href);
  });

  // import
  $('#btn-import')?.addEventListener('click',()=>{
    const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
    inp.onchange=async()=>{ const f=inp.files?.[0]; if(!f) return;
      let data; try{data=JSON.parse(await f.text())}catch{return alert('Bad JSON')}
      if(!Array.isArray(data.cards)) return alert('JSON missing "cards"');
      data.cards.forEach(c=>{
        const el=document.createElement('article'); el.className='card';
        el.innerHTML=`
          <div class="top">
            <img class="avatar" src="${(c.avatar||'').replace(/"/g,'&quot;')}" alt="">
            <div>
              <div class="name">${(c.name||'Unnamed').replace(/</g,'&lt;')}</div>
              <div class="tags">${(c.tags||[]).map(t=>`<span class="tag">${String(t).replace(/</g,'&lt;')}</span>`).join('')}</div>
            </div>
          </div>
          <div class="actions">
            <button class="pill primary">Use in Chat</button>
            <button class="pill primary">Use in Writer</button>
            <button class="pill ghost">Edit</button>
            <button class="pill ghost">Duplicate</button>
            <button class="pill ghost">Favorite</button>
            <button class="pill ghost">Delete</button>
          </div>`;
        cards.appendChild(el);
      });
      goTab('roster');
    };
    inp.click();
  });

  // editor: upload preview
  const up=$('#btn-upload'), clr=$('#btn-clearpic'), prevBox=$('#pic-preview'), prevImg=$('#pic-img');
  up?.addEventListener('click',()=>{
    const i=document.createElement('input'); i.type='file'; i.accept='image/*';
    i.onchange=()=>{ const f=i.files?.[0]; if(!f) return;
      const r=new FileReader(); r.onload=()=>{ prevImg.src=r.result; prevBox.style.display='block'; }; r.readAsDataURL(f);
    };
    i.click();
  });
  clr?.addEventListener('click',()=>{ prevImg.src=''; prevBox.style.display='none'; });

  // save/undo demos so buttons aren’t dead
  $('#btn-save')?.addEventListener('click',()=>alert('Saved (demo). Next: persist to localStorage.'));
  $('#btn-undo')?.addEventListener('click',()=>alert('Undone (demo).'));
})();
</body>
</html>